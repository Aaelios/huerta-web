WITH t AS (
  SELECT c.oid,
         n.nspname AS schema,
         c.relname AS table_name,
         c.relrowsecurity AS rls_enabled,
         c.reltuples::bigint AS approx_rows
  FROM pg_class c
  JOIN pg_namespace n ON n.oid = c.relnamespace
  WHERE n.nspname = 'public' AND c.relkind = 'r'
),
pk AS (
  SELECT i.indrelid AS oid,
         string_agg(a.attname, ', ' ORDER BY a.attnum) AS pk_cols
  FROM pg_index i
  JOIN pg_attribute a ON a.attrelid = i.indrelid AND a.attnum = ANY(i.indkey)
  WHERE i.indisprimary
  GROUP BY i.indrelid
),
fk AS (
  SELECT conrelid AS oid, count(*) AS fk_count
  FROM pg_constraint
  WHERE contype = 'f'
  GROUP BY conrelid
),
uq AS (
  SELECT i.indrelid AS oid, count(*) AS unique_count
  FROM pg_index i
  WHERE i.indisunique AND NOT i.indisprimary
  GROUP BY i.indrelid
),
pol AS (
  SELECT polrelid AS oid, count(*) AS policy_count
  FROM pg_policy
  GROUP BY polrelid
)
SELECT t.table_name,
       COALESCE(pk.pk_cols, '—')           AS pk_cols,
       COALESCE(fk.fk_count, 0)            AS fk_count,
       COALESCE(uq.unique_count, 0)        AS unique_count,
       t.rls_enabled,
       COALESCE(pol.policy_count, 0)       AS policy_count,
       t.approx_rows
FROM t
LEFT JOIN pk  ON pk.oid  = t.oid
LEFT JOIN fk  ON fk.oid  = t.oid
LEFT JOIN uq  ON uq.oid  = t.oid
LEFT JOIN pol ON pol.oid = t.oid
ORDER BY t.table_name;


| table_name          | pk_cols                                          | fk_count | unique_count | rls_enabled | policy_count | approx_rows |
| ------------------- | ------------------------------------------------ | -------- | ------------ | ----------- | ------------ | ----------- |
| bundle_items        | id                                               | 2        | 1            | true        | 2            | 2           |
| bundles             | bundle_sku                                       | 1        | 0            | true        | 2            | 1           |
| contacts            | id                                               | 1        | 1            | true        | 1            | -1          |
| entitlement_events  | id                                               | 1        | 0            | true        | 1            | -1          |
| entitlements        | id                                               | 1        | 3            | true        | 2            | -1          |
| exclusivity_members | sku, set_key                                     | 2        | 0            | true        | 2            | 1           |
| exclusivity_sets    | set_key                                          | 0        | 0            | true        | 2            | 1           |
| incompatibilities   | sku_a, sku_b                                     | 2        | 0            | true        | 2            | 1           |
| messages            | id                                               | 1        | 1            | true        | 1            | -1          |
| order_documents     | id                                               | 2        | 0            | true        | 2            | -1          |
| order_events        | id                                               | 1        | 0            | true        | 2            | -1          |
| order_headers       | id                                               | 0        | 5            | true        | 2            | -1          |
| order_items         | id                                               | 1        | 1            | true        | 2            | -1          |
| payments            | id                                               | 0        | 2            | true        | 2            | -1          |
| product_prices      | id                                               | 1        | 2            | true        | 2            | 1           |
| products            | sku                                              | 0        | 0            | true        | 2            | 4           |
| rate_limits         | scope, type, bucket, key_hash, window_started_at | 0        | 0            | true        | 0            | 0           |
| subscription_events | id                                               | 1        | 2            | true        | 2            | -1          |
| thankyou_copy       | id                                               | 1        | 1            | true        | 1            | -1          |
| webhook_events      | id                                               | 0        | 1            | true        | 2            | -1          |


-- Paso 4.2 — Columnas por tabla (public)
SELECT
  table_name,
  column_name,
  data_type,
  is_nullable                                AS nullability,          -- YES/NO
  COALESCE(column_default, '—')               AS column_default,
  is_generated,                               -- NEVER / ALWAYS
  COALESCE(generation_expression, '—')        AS generation_expression, -- para columnas generadas
  is_identity,                                -- YES/NO
  identity_generation                         -- ALWAYS / BY DEFAULT / null
FROM information_schema.columns
WHERE table_schema = 'public'
ORDER BY table_name, ordinal_position;

| table_name             | column_name               | data_type                | nullability | column_default    | is_generated | generation_expression | is_identity | identity_generation |
| ---------------------- | ------------------------- | ------------------------ | ----------- | ----------------- | ------------ | --------------------- | ----------- | ------------------- |
| bundle_items           | id                        | uuid                     | NO          | gen_random_uuid() | NEVER        | —                     | NO          | null                |
| bundle_items           | bundle_sku                | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| bundle_items           | child_sku                 | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| bundle_items           | qty                       | integer                  | NO          | 1                 | NEVER        | —                     | NO          | null                |
| bundle_items           | created_at                | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| bundle_items           | updated_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| bundles                | bundle_sku                | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| bundles                | updated_at                | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| bundles                | created_at                | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| contacts               | id                        | uuid                     | NO          | gen_random_uuid() | NEVER        | —                     | NO          | null                |
| contacts               | email                     | USER-DEFINED             | NO          | —                 | NEVER        | —                     | NO          | null                |
| contacts               | user_id                   | uuid                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| contacts               | status                    | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| contacts               | consent_status            | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| contacts               | consent_source            | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| contacts               | consent_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| contacts               | double_opt_in_at          | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| contacts               | segment                   | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| contacts               | utm                       | jsonb                    | NO          | '{}'::jsonb       | NEVER        | —                     | NO          | null                |
| contacts               | tech_metrics              | jsonb                    | NO          | '{}'::jsonb       | NEVER        | —                     | NO          | null                |
| contacts               | metadata                  | jsonb                    | NO          | '{}'::jsonb       | NEVER        | —                     | NO          | null                |
| contacts               | created_at                | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| contacts               | updated_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| contacts               | full_name                 | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| entitlement_events     | id                        | uuid                     | NO          | gen_random_uuid() | NEVER        | —                     | NO          | null                |
| entitlement_events     | entitlement_id            | uuid                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| entitlement_events     | type                      | USER-DEFINED             | NO          | —                 | NEVER        | —                     | NO          | null                |
| entitlement_events     | actor                     | text                     | NO          | 'system'::text    | NEVER        | —                     | NO          | null                |
| entitlement_events     | payload                   | jsonb                    | NO          | '{}'::jsonb       | NEVER        | —                     | NO          | null                |
| entitlement_events     | created_at                | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| entitlement_events     | updated_at                | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| entitlements           | id                        | uuid                     | NO          | gen_random_uuid() | NEVER        | —                     | NO          | null                |
| entitlements           | user_id                   | uuid                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| entitlements           | sku                       | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| entitlements           | fulfillment_type          | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| entitlements           | source_type               | USER-DEFINED             | NO          | —                 | NEVER        | —                     | NO          | null                |
| entitlements           | source_id                 | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| entitlements           | active                    | boolean                  | NO          | true              | NEVER        | —                     | NO          | null                |
| entitlements           | valid_until               | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| entitlements           | revoked_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| entitlements           | metadata                  | jsonb                    | NO          | '{}'::jsonb       | NEVER        | —                     | NO          | null                |
| entitlements           | created_at                | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| entitlements           | updated_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| exclusivity_members    | sku                       | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| exclusivity_members    | created_at                | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| exclusivity_members    | updated_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| exclusivity_members    | set_key                   | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| exclusivity_sets       | name                      | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| exclusivity_sets       | rule                      | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| exclusivity_sets       | created_at                | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| exclusivity_sets       | updated_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| exclusivity_sets       | set_key                   | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| incompatibilities      | sku_a                     | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| incompatibilities      | sku_b                     | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| messages               | id                        | uuid                     | NO          | gen_random_uuid() | NEVER        | —                     | NO          | null                |
| messages               | contact_id                | uuid                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| messages               | source                    | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| messages               | payload                   | jsonb                    | NO          | '{}'::jsonb       | NEVER        | —                     | NO          | null                |
| messages               | utm                       | jsonb                    | NO          | '{}'::jsonb       | NEVER        | —                     | NO          | null                |
| messages               | context                   | jsonb                    | NO          | '{}'::jsonb       | NEVER        | —                     | NO          | null                |
| messages               | processing_status         | text                     | NO          | 'received'::text  | NEVER        | —                     | NO          | null                |
| messages               | metadata                  | jsonb                    | NO          | '{}'::jsonb       | NEVER        | —                     | NO          | null                |
| messages               | created_at                | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| messages               | updated_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| order_documents        | id                        | uuid                     | NO          | gen_random_uuid() | NEVER        | —                     | NO          | null                |
| order_documents        | order_id                  | uuid                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| order_documents        | order_item_id             | uuid                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| order_documents        | doc_type                  | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| order_documents        | provider                  | text                     | NO          | 'stripe'::text    | NEVER        | —                     | NO          | null                |
| order_documents        | external_id               | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| order_documents        | url                       | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| order_documents        | metadata                  | jsonb                    | NO          | '{}'::jsonb       | NEVER        | —                     | NO          | null                |
| order_documents        | created_at                | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| order_documents        | updated_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| order_events           | id                        | uuid                     | NO          | gen_random_uuid() | NEVER        | —                     | NO          | null                |
| order_events           | order_id                  | uuid                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| order_events           | type                      | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| order_events           | actor                     | text                     | NO          | 'system'::text    | NEVER        | —                     | NO          | null                |
| order_events           | payload                   | jsonb                    | NO          | '{}'::jsonb       | NEVER        | —                     | NO          | null                |
| order_events           | created_at                | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| order_events           | updated_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| order_headers          | id                        | uuid                     | NO          | gen_random_uuid() | NEVER        | —                     | NO          | null                |
| order_headers          | user_id                   | uuid                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| order_headers          | total_cents               | integer                  | NO          | —                 | NEVER        | —                     | NO          | null                |
| order_headers          | currency                  | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| order_headers          | status                    | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| order_headers          | stripe_session_id         | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| order_headers          | stripe_payment_intent_id  | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| order_headers          | stripe_invoice_id         | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| order_headers          | stripe_subscription_id    | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| order_headers          | stripe_customer_id        | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| order_headers          | metadata                  | jsonb                    | NO          | '{}'::jsonb       | NEVER        | —                     | NO          | null                |
| order_headers          | created_at                | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| order_headers          | updated_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| order_headers          | fulfillment_status        | text                     | NO          | 'pending'::text   | NEVER        | —                     | NO          | null                |
| order_headers          | invoice_status            | text                     | NO          | 'none'::text      | NEVER        | —                     | NO          | null                |
| order_headers          | order_number              | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| order_headers          | receipt_sent_at           | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| order_headers          | receipt_provider_id       | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| order_items            | id                        | uuid                     | NO          | gen_random_uuid() | NEVER        | —                     | NO          | null                |
| order_items            | order_id                  | uuid                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| order_items            | sku                       | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| order_items            | product_type              | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| order_items            | amount_cents              | integer                  | NO          | —                 | NEVER        | —                     | NO          | null                |
| order_items            | quantity                  | integer                  | NO          | 1                 | NEVER        | —                     | NO          | null                |
| order_items            | metadata                  | jsonb                    | NO          | '{}'::jsonb       | NEVER        | —                     | NO          | null                |
| order_items            | created_at                | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| order_items            | updated_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| order_items            | line_number               | integer                  | NO          | —                 | NEVER        | —                     | NO          | null                |
| payments               | id                        | uuid                     | NO          | gen_random_uuid() | NEVER        | —                     | NO          | null                |
| payments               | user_id                   | uuid                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| payments               | order_id                  | uuid                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| payments               | total_cents               | integer                  | NO          | —                 | NEVER        | —                     | NO          | null                |
| payments               | currency                  | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| payments               | status                    | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| payments               | stripe_invoice_id         | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| payments               | stripe_payment_intent_id  | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| payments               | stripe_subscription_id    | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| payments               | stripe_customer_id        | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| payments               | stripe_charge_id          | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| payments               | period_start              | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| payments               | period_end                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| payments               | metadata                  | jsonb                    | NO          | '{}'::jsonb       | NEVER        | —                     | NO          | null                |
| payments               | created_at                | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| payments               | updated_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| product_prices         | id                        | uuid                     | NO          | gen_random_uuid() | NEVER        | —                     | NO          | null                |
| product_prices         | sku                       | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| product_prices         | amount_cents              | integer                  | NO          | —                 | NEVER        | —                     | NO          | null                |
| product_prices         | currency                  | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| product_prices         | price_list                | text                     | NO          | 'default'::text   | NEVER        | —                     | NO          | null                |
| product_prices         | interval                  | text                     | NO          | 'one_time'::text  | NEVER        | —                     | NO          | null                |
| product_prices         | valid_from                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| product_prices         | valid_until               | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| product_prices         | active                    | boolean                  | NO          | true              | NEVER        | —                     | NO          | null                |
| product_prices         | stripe_price_id           | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| product_prices         | metadata                  | jsonb                    | NO          | '{}'::jsonb       | NEVER        | —                     | NO          | null                |
| product_prices         | created_at                | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| product_prices         | updated_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| products               | sku                       | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| products               | name                      | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| products               | description               | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| products               | status                    | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| products               | visibility                | text                     | NO          | 'public'::text    | NEVER        | —                     | NO          | null                |
| products               | product_type              | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| products               | fulfillment_type          | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| products               | is_subscription           | boolean                  | NO          | false             | NEVER        | —                     | NO          | null                |
| products               | stripe_product_id         | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| products               | tax_code                  | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| products               | allow_discounts           | boolean                  | NO          | true              | NEVER        | —                     | NO          | null                |
| products               | commissionable            | boolean                  | NO          | false             | NEVER        | —                     | NO          | null                |
| products               | commission_rate_pct       | numeric                  | YES         | —                 | NEVER        | —                     | NO          | null                |
| products               | inventory_qty             | integer                  | YES         | —                 | NEVER        | —                     | NO          | null                |
| products               | weight_grams              | integer                  | YES         | —                 | NEVER        | —                     | NO          | null                |
| products               | available_from            | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| products               | available_until           | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| products               | metadata                  | jsonb                    | NO          | '{}'::jsonb       | NEVER        | —                     | NO          | null                |
| products               | created_at                | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| products               | updated_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| rate_limits            | scope                     | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| rate_limits            | type                      | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| rate_limits            | bucket                    | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| rate_limits            | key_hash                  | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| rate_limits            | window_started_at         | timestamp with time zone | NO          | —                 | NEVER        | —                     | NO          | null                |
| rate_limits            | count                     | integer                  | NO          | 0                 | NEVER        | —                     | NO          | null                |
| rate_limits            | updated_at                | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| subscription_events    | id                        | uuid                     | NO          | gen_random_uuid() | NEVER        | —                     | NO          | null                |
| subscription_events    | contact_id                | uuid                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| subscription_events    | event_type                | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| subscription_events    | source                    | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| subscription_events    | reason                    | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| subscription_events    | campaign_id               | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| subscription_events    | idempotency_key           | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| subscription_events    | metadata                  | jsonb                    | NO          | '{}'::jsonb       | NEVER        | —                     | NO          | null                |
| subscription_events    | occurred_at               | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| subscription_events    | created_at                | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| subscription_events    | updated_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| thankyou_copy          | id                        | uuid                     | NO          | gen_random_uuid() | NEVER        | —                     | NO          | null                |
| thankyou_copy          | sku                       | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| thankyou_copy          | locale                    | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| thankyou_copy          | country                   | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| thankyou_copy          | title                     | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| thankyou_copy          | body_md                   | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| thankyou_copy          | cta_label                 | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| thankyou_copy          | cta_slug                  | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| thankyou_copy          | created_at                | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| thankyou_copy          | updated_at                | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| v_entitlements_active  | id                        | uuid                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_entitlements_active  | user_id                   | uuid                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_entitlements_active  | sku                       | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_entitlements_active  | fulfillment_type          | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_entitlements_active  | source_type               | USER-DEFINED             | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_entitlements_active  | source_id                 | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_entitlements_active  | active                    | boolean                  | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_entitlements_active  | valid_until               | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_entitlements_active  | revoked_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_entitlements_active  | metadata                  | jsonb                    | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_entitlements_active  | created_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_entitlements_active  | updated_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_orders_with_payments | order_id                  | uuid                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_orders_with_payments | user_id                   | uuid                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_orders_with_payments | order_number              | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_orders_with_payments | order_total_cents         | integer                  | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_orders_with_payments | currency                  | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_orders_with_payments | order_status              | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_orders_with_payments | fulfillment_status        | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_orders_with_payments | invoice_status            | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_orders_with_payments | order_created_at          | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_orders_with_payments | stripe_session_id         | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_orders_with_payments | stripe_payment_intent_id  | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_orders_with_payments | stripe_invoice_id         | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_orders_with_payments | stripe_subscription_id    | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_orders_with_payments | stripe_customer_id        | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_orders_with_payments | payments_count            | integer                  | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_orders_with_payments | total_paid_cents          | integer                  | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_orders_with_payments | is_paid                   | boolean                  | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_orders_with_payments | balance_cents             | integer                  | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_orders_with_payments | last_paid_at              | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_orders_with_payments | last_payment_id           | uuid                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_prices_vigente       | id                        | uuid                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_prices_vigente       | sku                       | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_prices_vigente       | amount_cents              | integer                  | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_prices_vigente       | currency                  | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_prices_vigente       | price_list                | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_prices_vigente       | interval                  | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_prices_vigente       | valid_from                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_prices_vigente       | valid_until               | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_prices_vigente       | active                    | boolean                  | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_prices_vigente       | stripe_price_id           | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_prices_vigente       | metadata                  | jsonb                    | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_prices_vigente       | created_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_prices_vigente       | updated_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_products_public      | sku                       | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_products_public      | product_type              | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_products_public      | name                      | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_products_public      | description               | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_products_public      | status                    | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_products_public      | visibility                | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_products_public      | metadata                  | jsonb                    | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_products_public      | created_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_products_public      | updated_at                | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_products_public      | price_mxn_cents           | integer                  | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_products_public      | price_mxn_interval        | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_products_public      | price_mxn_stripe_price_id | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_products_public      | price_usd_cents           | integer                  | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_products_public      | price_usd_interval        | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| v_products_public      | price_usd_stripe_price_id | text                     | YES         | —                 | NEVER        | —                     | NO          | null                |
| webhook_events         | id                        | uuid                     | NO          | gen_random_uuid() | NEVER        | —                     | NO          | null                |
| webhook_events         | stripe_event_id           | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| webhook_events         | type                      | text                     | NO          | —                 | NEVER        | —                     | NO          | null                |
| webhook_events         | payload                   | jsonb                    | NO          | —                 | NEVER        | —                     | NO          | null                |
| webhook_events         | received_at               | timestamp with time zone | NO          | now()             | NEVER        | —                     | NO          | null                |
| webhook_events         | processed_at              | timestamp with time zone | YES         | —                 | NEVER        | —                     | NO          | null                |
| webhook_events         | order_id                  | uuid                     | YES         | —                 | NEVER        | —                     | NO          | null                |

-- PK y UNIQUE por tabla
WITH pk_uq AS (
  SELECT
    tc.table_name,
    tc.constraint_type,
    tc.constraint_name,
    string_agg(kcu.column_name, ', ' ORDER BY kcu.ordinal_position) AS columns
  FROM information_schema.table_constraints tc
  JOIN information_schema.key_column_usage kcu
    ON kcu.constraint_name = tc.constraint_name
   AND kcu.table_schema = tc.table_schema
  WHERE tc.table_schema = 'public'
    AND tc.constraint_type IN ('PRIMARY KEY','UNIQUE')
  GROUP BY tc.table_name, tc.constraint_type, tc.constraint_name
),
chk AS (
  SELECT
    tc.table_name,
    tc.constraint_name,
    cc.check_clause
  FROM information_schema.table_constraints tc
  JOIN information_schema.check_constraints cc
    ON cc.constraint_name = tc.constraint_name
  WHERE tc.table_schema = 'public'
    AND tc.constraint_type = 'CHECK'
),
fk AS (
  SELECT
    tc.table_name,
    tc.constraint_name,
    string_agg(kcu.column_name, ', ' ORDER BY kcu.ordinal_position) AS fk_columns,
    ccu.table_name AS ref_table,
    string_agg(ccu.column_name, ', ' ORDER BY kcu.ordinal_position) AS ref_columns,
    rc.update_rule,
    rc.delete_rule
  FROM information_schema.table_constraints tc
  JOIN information_schema.key_column_usage kcu
    ON kcu.constraint_name = tc.constraint_name
   AND kcu.table_schema = tc.table_schema
  JOIN information_schema.referential_constraints rc
    ON rc.constraint_name = tc.constraint_name
  JOIN information_schema.constraint_column_usage ccu
    ON ccu.constraint_name = rc.unique_constraint_name
  WHERE tc.table_schema = 'public'
    AND tc.constraint_type = 'FOREIGN KEY'
  GROUP BY tc.table_name, tc.constraint_name, ccu.table_name, rc.update_rule, rc.delete_rule
)
SELECT 'PK/UNIQUE' AS kind, table_name, constraint_name,
       columns AS details, NULL::text AS ref_table, NULL::text AS ref_columns,
       NULL::text AS on_update, NULL::text AS on_delete
FROM pk_uq
UNION ALL
SELECT 'CHECK', table_name, constraint_name,
       check_clause, NULL, NULL, NULL, NULL
FROM chk
UNION ALL
SELECT 'FOREIGN KEY', table_name, constraint_name,
       fk_columns, ref_table, ref_columns, update_rule, delete_rule
FROM fk
ORDER BY kind, table_name, constraint_name;

| kind        | table_name          | constraint_name                         | details                                                                                                                                                                                       | ref_table        | ref_columns | on_update | on_delete |
| ----------- | ------------------- | --------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------- | ----------- | --------- | --------- |
| CHECK       | bundle_items        | 2200_17422_1_not_null                   | id IS NOT NULL                                                                                                                                                                                | null             | null        | null      | null      |
| CHECK       | bundle_items        | 2200_17422_2_not_null                   | bundle_sku IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | bundle_items        | 2200_17422_3_not_null                   | child_sku IS NOT NULL                                                                                                                                                                         | null             | null        | null      | null      |
| CHECK       | bundle_items        | 2200_17422_4_not_null                   | qty IS NOT NULL                                                                                                                                                                               | null             | null        | null      | null      |
| CHECK       | bundle_items        | 2200_17422_5_not_null                   | created_at IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | bundle_items        | bundle_items_qty_check                  | (qty > 0)                                                                                                                                                                                     | null             | null        | null      | null      |
| CHECK       | bundle_items        | ck_bundle_items_no_self                 | (child_sku <> bundle_sku)                                                                                                                                                                     | null             | null        | null      | null      |
| CHECK       | bundles             | 2200_17410_1_not_null                   | bundle_sku IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | bundles             | 2200_17410_2_not_null                   | updated_at IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | bundles             | 2200_17410_3_not_null                   | created_at IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | contacts            | 2200_68260_10_not_null                  | utm IS NOT NULL                                                                                                                                                                               | null             | null        | null      | null      |
| CHECK       | contacts            | 2200_68260_11_not_null                  | tech_metrics IS NOT NULL                                                                                                                                                                      | null             | null        | null      | null      |
| CHECK       | contacts            | 2200_68260_12_not_null                  | metadata IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | contacts            | 2200_68260_13_not_null                  | created_at IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | contacts            | 2200_68260_1_not_null                   | id IS NOT NULL                                                                                                                                                                                | null             | null        | null      | null      |
| CHECK       | contacts            | 2200_68260_2_not_null                   | email IS NOT NULL                                                                                                                                                                             | null             | null        | null      | null      |
| CHECK       | contacts            | 2200_68260_4_not_null                   | status IS NOT NULL                                                                                                                                                                            | null             | null        | null      | null      |
| CHECK       | contacts            | 2200_68260_5_not_null                   | consent_status IS NOT NULL                                                                                                                                                                    | null             | null        | null      | null      |
| CHECK       | contacts            | ck_contacts__consent_source             | ((consent_source IS NULL) OR (consent_source = ANY (ARRAY['web_form'::text, 'checkout'::text, 'import'::text, 'api'::text])))                                                                 | null             | null        | null      | null      |
| CHECK       | contacts            | ck_contacts__consent_status             | (consent_status = ANY (ARRAY['none'::text, 'single_opt_in'::text, 'double_opt_in'::text]))                                                                                                    | null             | null        | null      | null      |
| CHECK       | contacts            | ck_contacts__status                     | (status = ANY (ARRAY['active'::text, 'unsubscribed'::text, 'bounced'::text, 'blocked'::text]))                                                                                                | null             | null        | null      | null      |
| CHECK       | entitlement_events  | 2200_18767_1_not_null                   | id IS NOT NULL                                                                                                                                                                                | null             | null        | null      | null      |
| CHECK       | entitlement_events  | 2200_18767_2_not_null                   | entitlement_id IS NOT NULL                                                                                                                                                                    | null             | null        | null      | null      |
| CHECK       | entitlement_events  | 2200_18767_3_not_null                   | type IS NOT NULL                                                                                                                                                                              | null             | null        | null      | null      |
| CHECK       | entitlement_events  | 2200_18767_4_not_null                   | actor IS NOT NULL                                                                                                                                                                             | null             | null        | null      | null      |
| CHECK       | entitlement_events  | 2200_18767_5_not_null                   | payload IS NOT NULL                                                                                                                                                                           | null             | null        | null      | null      |
| CHECK       | entitlement_events  | 2200_18767_6_not_null                   | created_at IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | entitlement_events  | 2200_18767_7_not_null                   | updated_at IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | entitlement_events  | ck_entitlement_events_type              | (type = ANY (ARRAY['grant'::entitlement_event_type, 'renew'::entitlement_event_type, 'revoke'::entitlement_event_type, 'expire'::entitlement_event_type, 'restore'::entitlement_event_type])) | null             | null        | null      | null      |
| CHECK       | entitlements        | 2200_17286_10_not_null                  | metadata IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | entitlements        | 2200_17286_11_not_null                  | created_at IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | entitlements        | 2200_17286_1_not_null                   | id IS NOT NULL                                                                                                                                                                                | null             | null        | null      | null      |
| CHECK       | entitlements        | 2200_17286_2_not_null                   | user_id IS NOT NULL                                                                                                                                                                           | null             | null        | null      | null      |
| CHECK       | entitlements        | 2200_17286_3_not_null                   | sku IS NOT NULL                                                                                                                                                                               | null             | null        | null      | null      |
| CHECK       | entitlements        | 2200_17286_4_not_null                   | fulfillment_type IS NOT NULL                                                                                                                                                                  | null             | null        | null      | null      |
| CHECK       | entitlements        | 2200_17286_5_not_null                   | source_type IS NOT NULL                                                                                                                                                                       | null             | null        | null      | null      |
| CHECK       | entitlements        | 2200_17286_7_not_null                   | active IS NOT NULL                                                                                                                                                                            | null             | null        | null      | null      |
| CHECK       | entitlements        | entitlements_fulfillment_type_check     | (fulfillment_type = ANY (ARRAY['course'::text, 'template'::text, 'live_class'::text, 'one_to_one'::text, 'subscription_grant'::text]))                                                        | null             | null        | null      | null      |
| CHECK       | exclusivity_members | 2200_17454_2_not_null                   | sku IS NOT NULL                                                                                                                                                                               | null             | null        | null      | null      |
| CHECK       | exclusivity_members | 2200_17454_3_not_null                   | created_at IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | exclusivity_members | 2200_17454_5_not_null                   | set_key IS NOT NULL                                                                                                                                                                           | null             | null        | null      | null      |
| CHECK       | exclusivity_sets    | 2200_17444_2_not_null                   | name IS NOT NULL                                                                                                                                                                              | null             | null        | null      | null      |
| CHECK       | exclusivity_sets    | 2200_17444_3_not_null                   | rule IS NOT NULL                                                                                                                                                                              | null             | null        | null      | null      |
| CHECK       | exclusivity_sets    | 2200_17444_4_not_null                   | created_at IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | exclusivity_sets    | 2200_17444_6_not_null                   | set_key IS NOT NULL                                                                                                                                                                           | null             | null        | null      | null      |
| CHECK       | exclusivity_sets    | ck_exclusivity_sets_set_key_format      | ((char_length(set_key) <= 60) AND (set_key ~ '^[a-z0-9_-]+$'::text))                                                                                                                          | null             | null        | null      | null      |
| CHECK       | exclusivity_sets    | exclusivity_sets_rule_check             | (rule = ANY (ARRAY['mutually_exclusive'::text, 'single_selection'::text]))                                                                                                                    | null             | null        | null      | null      |
| CHECK       | incompatibilities   | 2200_17472_1_not_null                   | sku_a IS NOT NULL                                                                                                                                                                             | null             | null        | null      | null      |
| CHECK       | incompatibilities   | 2200_17472_2_not_null                   | sku_b IS NOT NULL                                                                                                                                                                             | null             | null        | null      | null      |
| CHECK       | incompatibilities   | ck_incompat_order                       | (sku_a < sku_b)                                                                                                                                                                               | null             | null        | null      | null      |
| CHECK       | messages            | 2200_68354_1_not_null                   | id IS NOT NULL                                                                                                                                                                                | null             | null        | null      | null      |
| CHECK       | messages            | 2200_68354_2_not_null                   | contact_id IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | messages            | 2200_68354_3_not_null                   | source IS NOT NULL                                                                                                                                                                            | null             | null        | null      | null      |
| CHECK       | messages            | 2200_68354_4_not_null                   | payload IS NOT NULL                                                                                                                                                                           | null             | null        | null      | null      |
| CHECK       | messages            | 2200_68354_5_not_null                   | utm IS NOT NULL                                                                                                                                                                               | null             | null        | null      | null      |
| CHECK       | messages            | 2200_68354_6_not_null                   | context IS NOT NULL                                                                                                                                                                           | null             | null        | null      | null      |
| CHECK       | messages            | 2200_68354_7_not_null                   | processing_status IS NOT NULL                                                                                                                                                                 | null             | null        | null      | null      |
| CHECK       | messages            | 2200_68354_8_not_null                   | metadata IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | messages            | 2200_68354_9_not_null                   | created_at IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | messages            | ck_messages__processing_status          | (processing_status = ANY (ARRAY['received'::text, 'queued'::text, 'sent_to_crm'::text, 'discarded'::text]))                                                                                   | null             | null        | null      | null      |
| CHECK       | messages            | ck_messages__source                     | (source = ANY (ARRAY['web_form'::text, 'checkout'::text, 'import'::text, 'api'::text]))                                                                                                       | null             | null        | null      | null      |
| CHECK       | order_documents     | 2200_17533_1_not_null                   | id IS NOT NULL                                                                                                                                                                                | null             | null        | null      | null      |
| CHECK       | order_documents     | 2200_17533_2_not_null                   | order_id IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | order_documents     | 2200_17533_4_not_null                   | doc_type IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | order_documents     | 2200_17533_5_not_null                   | provider IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | order_documents     | 2200_17533_8_not_null                   | metadata IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | order_documents     | 2200_17533_9_not_null                   | created_at IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | order_documents     | order_documents_doc_type_check          | (doc_type = ANY (ARRAY['invoice'::text, 'ticket'::text, 'receipt'::text, 'credit_note'::text]))                                                                                               | null             | null        | null      | null      |
| CHECK       | order_events        | 2200_17515_1_not_null                   | id IS NOT NULL                                                                                                                                                                                | null             | null        | null      | null      |
| CHECK       | order_events        | 2200_17515_2_not_null                   | order_id IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | order_events        | 2200_17515_3_not_null                   | type IS NOT NULL                                                                                                                                                                              | null             | null        | null      | null      |
| CHECK       | order_events        | 2200_17515_4_not_null                   | actor IS NOT NULL                                                                                                                                                                             | null             | null        | null      | null      |
| CHECK       | order_events        | 2200_17515_5_not_null                   | payload IS NOT NULL                                                                                                                                                                           | null             | null        | null      | null      |
| CHECK       | order_events        | 2200_17515_6_not_null                   | created_at IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | order_events        | ck_order_events_type                    | (type = ANY (ARRAY['created'::text, 'paid'::text, 'fulfilled'::text, 'scheduled'::text, 'refunded'::text, 'canceled'::text]))                                                                 | null             | null        | null      | null      |
| CHECK       | order_headers       | 2200_17323_11_not_null                  | metadata IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | order_headers       | 2200_17323_12_not_null                  | created_at IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | order_headers       | 2200_17323_14_not_null                  | fulfillment_status IS NOT NULL                                                                                                                                                                | null             | null        | null      | null      |
| CHECK       | order_headers       | 2200_17323_15_not_null                  | invoice_status IS NOT NULL                                                                                                                                                                    | null             | null        | null      | null      |
| CHECK       | order_headers       | 2200_17323_16_not_null                  | order_number IS NOT NULL                                                                                                                                                                      | null             | null        | null      | null      |
| CHECK       | order_headers       | 2200_17323_1_not_null                   | id IS NOT NULL                                                                                                                                                                                | null             | null        | null      | null      |
| CHECK       | order_headers       | 2200_17323_2_not_null                   | user_id IS NOT NULL                                                                                                                                                                           | null             | null        | null      | null      |
| CHECK       | order_headers       | 2200_17323_3_not_null                   | total_cents IS NOT NULL                                                                                                                                                                       | null             | null        | null      | null      |
| CHECK       | order_headers       | 2200_17323_4_not_null                   | currency IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | order_headers       | 2200_17323_5_not_null                   | status IS NOT NULL                                                                                                                                                                            | null             | null        | null      | null      |
| CHECK       | order_headers       | ck_order_headers_order_number_format    | (order_number ~ '^ORD-\d{6}$'::text)                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | order_headers       | order_headers_fulfillment_status_check  | (fulfillment_status = ANY (ARRAY['pending'::text, 'fulfilled'::text, 'revoked'::text]))                                                                                                       | null             | null        | null      | null      |
| CHECK       | order_headers       | order_headers_invoice_status_check      | (invoice_status = ANY (ARRAY['none'::text, 'invoiced'::text, 'credit_issued'::text]))                                                                                                         | null             | null        | null      | null      |
| CHECK       | order_headers       | order_headers_status_check              | (status = ANY (ARRAY['paid'::text, 'refunded'::text, 'canceled'::text, 'unpaid'::text]))                                                                                                      | null             | null        | null      | null      |
| CHECK       | order_items         | 2200_17339_10_not_null                  | line_number IS NOT NULL                                                                                                                                                                       | null             | null        | null      | null      |
| CHECK       | order_items         | 2200_17339_1_not_null                   | id IS NOT NULL                                                                                                                                                                                | null             | null        | null      | null      |
| CHECK       | order_items         | 2200_17339_2_not_null                   | order_id IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | order_items         | 2200_17339_3_not_null                   | sku IS NOT NULL                                                                                                                                                                               | null             | null        | null      | null      |
| CHECK       | order_items         | 2200_17339_4_not_null                   | product_type IS NOT NULL                                                                                                                                                                      | null             | null        | null      | null      |
| CHECK       | order_items         | 2200_17339_5_not_null                   | amount_cents IS NOT NULL                                                                                                                                                                      | null             | null        | null      | null      |
| CHECK       | order_items         | 2200_17339_6_not_null                   | quantity IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | order_items         | 2200_17339_7_not_null                   | metadata IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | order_items         | 2200_17339_8_not_null                   | created_at IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | order_items         | ck_order_items_line_number_pos          | (line_number > 0)                                                                                                                                                                             | null             | null        | null      | null      |
| CHECK       | order_items         | order_items_product_type_check          | (product_type = ANY (ARRAY['course'::text, 'template'::text, 'live_class'::text, 'one_to_one'::text, 'subscription_grant'::text, 'bundle'::text]))                                            | null             | null        | null      | null      |
| CHECK       | order_items         | order_items_quantity_check              | (quantity > 0)                                                                                                                                                                                | null             | null        | null      | null      |
| CHECK       | payments            | 2200_23050_14_not_null                  | metadata IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | payments            | 2200_23050_15_not_null                  | created_at IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | payments            | 2200_23050_1_not_null                   | id IS NOT NULL                                                                                                                                                                                | null             | null        | null      | null      |
| CHECK       | payments            | 2200_23050_2_not_null                   | user_id IS NOT NULL                                                                                                                                                                           | null             | null        | null      | null      |
| CHECK       | payments            | 2200_23050_4_not_null                   | total_cents IS NOT NULL                                                                                                                                                                       | null             | null        | null      | null      |
| CHECK       | payments            | 2200_23050_5_not_null                   | currency IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | payments            | 2200_23050_6_not_null                   | status IS NOT NULL                                                                                                                                                                            | null             | null        | null      | null      |
| CHECK       | payments            | payments_currency_check                 | (currency ~ '^[a-z]{3}$'::text)                                                                                                                                                               | null             | null        | null      | null      |
| CHECK       | payments            | payments_status_check                   | (status = ANY (ARRAY['paid'::text, 'refunded'::text, 'failed'::text, 'canceled'::text]))                                                                                                      | null             | null        | null      | null      |
| CHECK       | payments            | payments_total_cents_check              | (total_cents >= 0)                                                                                                                                                                            | null             | null        | null      | null      |
| CHECK       | product_prices      | 2200_17387_11_not_null                  | metadata IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | product_prices      | 2200_17387_12_not_null                  | created_at IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | product_prices      | 2200_17387_1_not_null                   | id IS NOT NULL                                                                                                                                                                                | null             | null        | null      | null      |
| CHECK       | product_prices      | 2200_17387_2_not_null                   | sku IS NOT NULL                                                                                                                                                                               | null             | null        | null      | null      |
| CHECK       | product_prices      | 2200_17387_3_not_null                   | amount_cents IS NOT NULL                                                                                                                                                                      | null             | null        | null      | null      |
| CHECK       | product_prices      | 2200_17387_4_not_null                   | currency IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | product_prices      | 2200_17387_5_not_null                   | price_list IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | product_prices      | 2200_17387_6_not_null                   | interval IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | product_prices      | 2200_17387_9_not_null                   | active IS NOT NULL                                                                                                                                                                            | null             | null        | null      | null      |
| CHECK       | product_prices      | ck_product_prices_amount_positive       | (amount_cents > 0)                                                                                                                                                                            | null             | null        | null      | null      |
| CHECK       | product_prices      | ck_product_prices_currency              | (currency = ANY (ARRAY['MXN'::text, 'USD'::text]))                                                                                                                                            | null             | null        | null      | null      |
| CHECK       | product_prices      | ck_product_prices_list                  | (price_list = ANY (ARRAY['default'::text, 'launch'::text]))                                                                                                                                   | null             | null        | null      | null      |
| CHECK       | product_prices      | ck_product_prices_valid_window          | ((valid_until IS NULL) OR (valid_from IS NULL) OR (valid_until > valid_from))                                                                                                                 | null             | null        | null      | null      |
| CHECK       | product_prices      | product_prices_interval_check           | ("interval" = ANY (ARRAY['one_time'::text, 'month'::text, 'year'::text]))                                                                                                                     | null             | null        | null      | null      |
| CHECK       | products            | 2200_17370_11_not_null                  | allow_discounts IS NOT NULL                                                                                                                                                                   | null             | null        | null      | null      |
| CHECK       | products            | 2200_17370_12_not_null                  | commissionable IS NOT NULL                                                                                                                                                                    | null             | null        | null      | null      |
| CHECK       | products            | 2200_17370_18_not_null                  | metadata IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | products            | 2200_17370_19_not_null                  | created_at IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | products            | 2200_17370_1_not_null                   | sku IS NOT NULL                                                                                                                                                                               | null             | null        | null      | null      |
| CHECK       | products            | 2200_17370_2_not_null                   | name IS NOT NULL                                                                                                                                                                              | null             | null        | null      | null      |
| CHECK       | products            | 2200_17370_4_not_null                   | status IS NOT NULL                                                                                                                                                                            | null             | null        | null      | null      |
| CHECK       | products            | 2200_17370_5_not_null                   | visibility IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | products            | 2200_17370_6_not_null                   | product_type IS NOT NULL                                                                                                                                                                      | null             | null        | null      | null      |
| CHECK       | products            | 2200_17370_7_not_null                   | fulfillment_type IS NOT NULL                                                                                                                                                                  | null             | null        | null      | null      |
| CHECK       | products            | 2200_17370_8_not_null                   | is_subscription IS NOT NULL                                                                                                                                                                   | null             | null        | null      | null      |
| CHECK       | products            | ck_products_sku_format                  | (sku ~ '^[a-z0-9-]+-v[0-9]{3}$'::text)                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | products            | ck_products_visibility                  | (visibility = ANY (ARRAY['public'::text, 'private'::text, 'hidden'::text]))                                                                                                                   | null             | null        | null      | null      |
| CHECK       | products            | products_fulfillment_type_check         | (fulfillment_type = ANY (ARRAY['course'::text, 'template'::text, 'live_class'::text, 'one_to_one'::text, 'subscription_grant'::text, 'bundle'::text]))                                        | null             | null        | null      | null      |
| CHECK       | products            | products_product_type_check             | (product_type = ANY (ARRAY['digital'::text, 'physical'::text, 'service'::text, 'subscription_grant'::text]))                                                                                  | null             | null        | null      | null      |
| CHECK       | products            | products_status_check                   | (status = ANY (ARRAY['planned'::text, 'active'::text, 'sunsetting'::text, 'discontinued'::text]))                                                                                             | null             | null        | null      | null      |
| CHECK       | rate_limits         | 2200_70920_1_not_null                   | scope IS NOT NULL                                                                                                                                                                             | null             | null        | null      | null      |
| CHECK       | rate_limits         | 2200_70920_2_not_null                   | type IS NOT NULL                                                                                                                                                                              | null             | null        | null      | null      |
| CHECK       | rate_limits         | 2200_70920_3_not_null                   | bucket IS NOT NULL                                                                                                                                                                            | null             | null        | null      | null      |
| CHECK       | rate_limits         | 2200_70920_4_not_null                   | key_hash IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | rate_limits         | 2200_70920_5_not_null                   | window_started_at IS NOT NULL                                                                                                                                                                 | null             | null        | null      | null      |
| CHECK       | rate_limits         | 2200_70920_6_not_null                   | count IS NOT NULL                                                                                                                                                                             | null             | null        | null      | null      |
| CHECK       | rate_limits         | 2200_70920_7_not_null                   | updated_at IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | rate_limits         | rate_limits_bucket_check                | (bucket = ANY (ARRAY['burst'::text, 'sustained'::text]))                                                                                                                                      | null             | null        | null      | null      |
| CHECK       | subscription_events | 2200_68448_10_not_null                  | created_at IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | subscription_events | 2200_68448_1_not_null                   | id IS NOT NULL                                                                                                                                                                                | null             | null        | null      | null      |
| CHECK       | subscription_events | 2200_68448_2_not_null                   | contact_id IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | subscription_events | 2200_68448_3_not_null                   | event_type IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | subscription_events | 2200_68448_4_not_null                   | source IS NOT NULL                                                                                                                                                                            | null             | null        | null      | null      |
| CHECK       | subscription_events | 2200_68448_8_not_null                   | metadata IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | subscription_events | 2200_68448_9_not_null                   | occurred_at IS NOT NULL                                                                                                                                                                       | null             | null        | null      | null      |
| CHECK       | subscription_events | ck_subscription_events__event_type      | (event_type = ANY (ARRAY['opt_in'::text, 'double_opt_in'::text, 'unsubscribe'::text, 'bounce'::text, 'complaint'::text]))                                                                     | null             | null        | null      | null      |
| CHECK       | subscription_events | ck_subscription_events__source          | (source = ANY (ARRAY['web_form'::text, 'checkout'::text, 'import'::text, 'api'::text, 'provider_webhook'::text]))                                                                             | null             | null        | null      | null      |
| CHECK       | thankyou_copy       | 2200_55166_10_not_null                  | updated_at IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | thankyou_copy       | 2200_55166_1_not_null                   | id IS NOT NULL                                                                                                                                                                                | null             | null        | null      | null      |
| CHECK       | thankyou_copy       | 2200_55166_2_not_null                   | sku IS NOT NULL                                                                                                                                                                               | null             | null        | null      | null      |
| CHECK       | thankyou_copy       | 2200_55166_3_not_null                   | locale IS NOT NULL                                                                                                                                                                            | null             | null        | null      | null      |
| CHECK       | thankyou_copy       | 2200_55166_5_not_null                   | title IS NOT NULL                                                                                                                                                                             | null             | null        | null      | null      |
| CHECK       | thankyou_copy       | 2200_55166_6_not_null                   | body_md IS NOT NULL                                                                                                                                                                           | null             | null        | null      | null      |
| CHECK       | thankyou_copy       | 2200_55166_7_not_null                   | cta_label IS NOT NULL                                                                                                                                                                         | null             | null        | null      | null      |
| CHECK       | thankyou_copy       | 2200_55166_8_not_null                   | cta_slug IS NOT NULL                                                                                                                                                                          | null             | null        | null      | null      |
| CHECK       | thankyou_copy       | 2200_55166_9_not_null                   | created_at IS NOT NULL                                                                                                                                                                        | null             | null        | null      | null      |
| CHECK       | thankyou_copy       | thankyou_copy_country_chk               | ((country IS NULL) OR ((char_length(country) = 2) AND (country = upper(country))))                                                                                                            | null             | null        | null      | null      |
| CHECK       | thankyou_copy       | thankyou_copy_cta_slug_no_spaces        | (cta_slug !~ '\s'::text)                                                                                                                                                                      | null             | null        | null      | null      |
| CHECK       | thankyou_copy       | thankyou_copy_cta_slug_no_url           | (cta_slug !~* 'https?://'::text)                                                                                                                                                              | null             | null        | null      | null      |
| CHECK       | webhook_events      | 2200_17303_1_not_null                   | id IS NOT NULL                                                                                                                                                                                | null             | null        | null      | null      |
| CHECK       | webhook_events      | 2200_17303_2_not_null                   | stripe_event_id IS NOT NULL                                                                                                                                                                   | null             | null        | null      | null      |
| CHECK       | webhook_events      | 2200_17303_3_not_null                   | type IS NOT NULL                                                                                                                                                                              | null             | null        | null      | null      |
| CHECK       | webhook_events      | 2200_17303_4_not_null                   | payload IS NOT NULL                                                                                                                                                                           | null             | null        | null      | null      |
| CHECK       | webhook_events      | 2200_17303_5_not_null                   | received_at IS NOT NULL                                                                                                                                                                       | null             | null        | null      | null      |
| FOREIGN KEY | bundle_items        | bundle_items_bundle_sku_fkey            | bundle_sku                                                                                                                                                                                    | bundles          | bundle_sku  | NO ACTION | CASCADE   |
| FOREIGN KEY | bundle_items        | bundle_items_child_sku_fkey             | child_sku                                                                                                                                                                                     | products         | sku         | NO ACTION | CASCADE   |
| FOREIGN KEY | bundles             | bundles_bundle_sku_fkey                 | bundle_sku                                                                                                                                                                                    | products         | sku         | NO ACTION | CASCADE   |
| FOREIGN KEY | entitlement_events  | entitlement_events_entitlement_id_fkey  | entitlement_id                                                                                                                                                                                | entitlements     | id          | NO ACTION | CASCADE   |
| FOREIGN KEY | entitlements        | entitlements_sku_fkey                   | sku                                                                                                                                                                                           | products         | sku         | NO ACTION | RESTRICT  |
| FOREIGN KEY | exclusivity_members | exclusivity_members_set_key_fkey        | set_key                                                                                                                                                                                       | exclusivity_sets | set_key     | NO ACTION | CASCADE   |
| FOREIGN KEY | exclusivity_members | exclusivity_members_sku_fkey            | sku                                                                                                                                                                                           | products         | sku         | NO ACTION | NO ACTION |
| FOREIGN KEY | incompatibilities   | incompatibilities_sku_a_fkey            | sku_a                                                                                                                                                                                         | products         | sku         | NO ACTION | NO ACTION |
| FOREIGN KEY | incompatibilities   | incompatibilities_sku_b_fkey            | sku_b                                                                                                                                                                                         | products         | sku         | NO ACTION | NO ACTION |
| FOREIGN KEY | messages            | fk_messages__contact                    | contact_id                                                                                                                                                                                    | contacts         | id          | NO ACTION | RESTRICT  |
| FOREIGN KEY | order_documents     | order_documents_order_id_fkey           | order_id                                                                                                                                                                                      | order_headers    | id          | NO ACTION | CASCADE   |
| FOREIGN KEY | order_documents     | order_documents_order_item_id_fkey      | order_item_id                                                                                                                                                                                 | order_items      | id          | NO ACTION | SET NULL  |
| FOREIGN KEY | order_events        | order_events_order_id_fkey              | order_id                                                                                                                                                                                      | order_headers    | id          | NO ACTION | CASCADE   |
| FOREIGN KEY | order_items         | order_items_order_id_fkey               | order_id                                                                                                                                                                                      | order_headers    | id          | NO ACTION | CASCADE   |
| FOREIGN KEY | product_prices      | product_prices_sku_fkey                 | sku                                                                                                                                                                                           | products         | sku         | NO ACTION | CASCADE   |
| FOREIGN KEY | subscription_events | fk_subscription_events__contact         | contact_id                                                                                                                                                                                    | contacts         | id          | NO ACTION | RESTRICT  |
| FOREIGN KEY | thankyou_copy       | thankyou_copy_sku_fkey                  | sku                                                                                                                                                                                           | products         | sku         | CASCADE   | CASCADE   |
| PK/UNIQUE   | bundle_items        | bundle_items_pkey                       | id                                                                                                                                                                                            | null             | null        | null      | null      |
| PK/UNIQUE   | bundles             | bundles_pkey                            | bundle_sku                                                                                                                                                                                    | null             | null        | null      | null      |
| PK/UNIQUE   | contacts            | contacts_pkey                           | id                                                                                                                                                                                            | null             | null        | null      | null      |
| PK/UNIQUE   | contacts            | ux_contacts__email                      | email                                                                                                                                                                                         | null             | null        | null      | null      |
| PK/UNIQUE   | entitlement_events  | entitlement_events_pkey                 | id                                                                                                                                                                                            | null             | null        | null      | null      |
| PK/UNIQUE   | entitlements        | entitlements_pkey                       | id                                                                                                                                                                                            | null             | null        | null      | null      |
| PK/UNIQUE   | exclusivity_members | exclusivity_members_pkey                | set_key, sku                                                                                                                                                                                  | null             | null        | null      | null      |
| PK/UNIQUE   | exclusivity_sets    | exclusivity_sets_pkey                   | set_key                                                                                                                                                                                       | null             | null        | null      | null      |
| PK/UNIQUE   | incompatibilities   | incompatibilities_pkey                  | sku_a, sku_b                                                                                                                                                                                  | null             | null        | null      | null      |
| PK/UNIQUE   | messages            | messages_pkey                           | id                                                                                                                                                                                            | null             | null        | null      | null      |
| PK/UNIQUE   | order_documents     | order_documents_pkey                    | id                                                                                                                                                                                            | null             | null        | null      | null      |
| PK/UNIQUE   | order_events        | order_events_pkey                       | id                                                                                                                                                                                            | null             | null        | null      | null      |
| PK/UNIQUE   | order_headers       | order_headers_pkey                      | id                                                                                                                                                                                            | null             | null        | null      | null      |
| PK/UNIQUE   | order_headers       | order_headers_stripe_session_id_key     | stripe_session_id                                                                                                                                                                             | null             | null        | null      | null      |
| PK/UNIQUE   | order_items         | order_items_pkey                        | id                                                                                                                                                                                            | null             | null        | null      | null      |
| PK/UNIQUE   | payments            | payments_pkey                           | id                                                                                                                                                                                            | null             | null        | null      | null      |
| PK/UNIQUE   | product_prices      | product_prices_pkey                     | id                                                                                                                                                                                            | null             | null        | null      | null      |
| PK/UNIQUE   | products            | products_pkey                           | sku                                                                                                                                                                                           | null             | null        | null      | null      |
| PK/UNIQUE   | rate_limits         | rate_limits_pkey                        | scope, type, bucket, key_hash, window_started_at                                                                                                                                              | null             | null        | null      | null      |
| PK/UNIQUE   | subscription_events | subscription_events_idempotency_key_key | idempotency_key                                                                                                                                                                               | null             | null        | null      | null      |
| PK/UNIQUE   | subscription_events | subscription_events_pkey                | id                                                                                                                                                                                            | null             | null        | null      | null      |
| PK/UNIQUE   | thankyou_copy       | thankyou_copy_pkey                      | id                                                                                                                                                                                            | null             | null        | null      | null      |
| PK/UNIQUE   | webhook_events      | webhook_events_pkey                     | id                                                                                                                                                                                            | null             | null        | null      | null      |
| PK/UNIQUE   | webhook_events      | webhook_events_stripe_event_id_key      | stripe_event_id                                                                                                                                                                               | null             | null        | null      | null      |


-- Paso 4.4 — Índices explícitos en schema public
SELECT
  t.relname AS table_name,
  i.relname AS index_name,
  pg_get_indexdef(ix.indexrelid) AS index_def,
  ix.indisunique AS is_unique,
  ix.indisprimary AS is_primary
FROM pg_index ix
JOIN pg_class t ON t.oid = ix.indrelid
JOIN pg_class i ON i.oid = ix.indexrelid
JOIN pg_namespace n ON n.oid = t.relnamespace
WHERE n.nspname = 'public'
  AND ix.indisprimary = false   -- excluye PK
ORDER BY t.relname, i.relname;

| table_name          | index_name                              | index_def                                                                                                                                                                              | is_unique | is_primary |
| ------------------- | --------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------- | ---------- |
| bundle_items        | ux_bundle_items_pair                    | CREATE UNIQUE INDEX ux_bundle_items_pair ON public.bundle_items USING btree (bundle_sku, child_sku)                                                                                    | true      | false      |
| contacts            | idx_contacts__consent_status            | CREATE INDEX idx_contacts__consent_status ON public.contacts USING btree (consent_status)                                                                                              | false     | false      |
| contacts            | idx_contacts__created_at                | CREATE INDEX idx_contacts__created_at ON public.contacts USING btree (created_at)                                                                                                      | false     | false      |
| contacts            | idx_contacts__status                    | CREATE INDEX idx_contacts__status ON public.contacts USING btree (status)                                                                                                              | false     | false      |
| contacts            | idx_contacts__user_id                   | CREATE INDEX idx_contacts__user_id ON public.contacts USING btree (user_id)                                                                                                            | false     | false      |
| contacts            | ux_contacts__email                      | CREATE UNIQUE INDEX ux_contacts__email ON public.contacts USING btree (email)                                                                                                          | true      | false      |
| entitlement_events  | idx_entitlement_events_created_at       | CREATE INDEX idx_entitlement_events_created_at ON public.entitlement_events USING btree (created_at DESC)                                                                              | false     | false      |
| entitlement_events  | idx_entitlement_events_entitlement_id   | CREATE INDEX idx_entitlement_events_entitlement_id ON public.entitlement_events USING btree (entitlement_id)                                                                           | false     | false      |
| entitlements        | idx_entitlements_active                 | CREATE INDEX idx_entitlements_active ON public.entitlements USING btree (active)                                                                                                       | false     | false      |
| entitlements        | idx_entitlements_sku                    | CREATE INDEX idx_entitlements_sku ON public.entitlements USING btree (sku)                                                                                                             | false     | false      |
| entitlements        | idx_entitlements_sku_active             | CREATE INDEX idx_entitlements_sku_active ON public.entitlements USING btree (sku, active)                                                                                              | false     | false      |
| entitlements        | idx_entitlements_user_active            | CREATE INDEX idx_entitlements_user_active ON public.entitlements USING btree (user_id, active)                                                                                         | false     | false      |
| entitlements        | idx_entitlements_user_id                | CREATE INDEX idx_entitlements_user_id ON public.entitlements USING btree (user_id)                                                                                                     | false     | false      |
| entitlements        | idx_entitlements_valid_until            | CREATE INDEX idx_entitlements_valid_until ON public.entitlements USING btree (valid_until)                                                                                             | false     | false      |
| entitlements        | ux_entitlements_active_one              | CREATE UNIQUE INDEX ux_entitlements_active_one ON public.entitlements USING btree (user_id, sku) WHERE (active IS TRUE)                                                                | true      | false      |
| entitlements        | ux_entitlements_idem                    | CREATE UNIQUE INDEX ux_entitlements_idem ON public.entitlements USING btree (user_id, sku, source_type, source_id)                                                                     | true      | false      |
| entitlements        | ux_entitlements_user_sku_active         | CREATE UNIQUE INDEX ux_entitlements_user_sku_active ON public.entitlements USING btree (user_id, sku) WHERE (active = true)                                                            | true      | false      |
| messages            | idx_messages__contact_id                | CREATE INDEX idx_messages__contact_id ON public.messages USING btree (contact_id)                                                                                                      | false     | false      |
| messages            | idx_messages__created_at                | CREATE INDEX idx_messages__created_at ON public.messages USING btree (created_at)                                                                                                      | false     | false      |
| messages            | idx_messages__processing_status         | CREATE INDEX idx_messages__processing_status ON public.messages USING btree (processing_status)                                                                                        | false     | false      |
| messages            | idx_messages__source                    | CREATE INDEX idx_messages__source ON public.messages USING btree (source)                                                                                                              | false     | false      |
| messages            | ux_messages_contact_request             | CREATE UNIQUE INDEX ux_messages_contact_request ON public.messages USING btree (contact_id, ((metadata ->> 'request_id'::text))) WHERE ((metadata ->> 'request_id'::text) IS NOT NULL) | true      | false      |
| order_documents     | idx_order_documents_order_id            | CREATE INDEX idx_order_documents_order_id ON public.order_documents USING btree (order_id)                                                                                             | false     | false      |
| order_documents     | idx_order_documents_type                | CREATE INDEX idx_order_documents_type ON public.order_documents USING btree (doc_type)                                                                                                 | false     | false      |
| order_events        | idx_order_events_order_id               | CREATE INDEX idx_order_events_order_id ON public.order_events USING btree (order_id)                                                                                                   | false     | false      |
| order_events        | idx_order_events_type                   | CREATE INDEX idx_order_events_type ON public.order_events USING btree (type)                                                                                                           | false     | false      |
| order_headers       | idx_order_headers_created_at            | CREATE INDEX idx_order_headers_created_at ON public.order_headers USING btree (created_at)                                                                                             | false     | false      |
| order_headers       | idx_order_headers_fulfillment_status    | CREATE INDEX idx_order_headers_fulfillment_status ON public.order_headers USING btree (fulfillment_status)                                                                             | false     | false      |
| order_headers       | idx_order_headers_invoice_status        | CREATE INDEX idx_order_headers_invoice_status ON public.order_headers USING btree (invoice_status)                                                                                     | false     | false      |
| order_headers       | idx_order_headers_status                | CREATE INDEX idx_order_headers_status ON public.order_headers USING btree (status)                                                                                                     | false     | false      |
| order_headers       | idx_order_headers_user_created_at       | CREATE INDEX idx_order_headers_user_created_at ON public.order_headers USING btree (user_id, created_at DESC)                                                                          | false     | false      |
| order_headers       | idx_order_headers_user_id               | CREATE INDEX idx_order_headers_user_id ON public.order_headers USING btree (user_id)                                                                                                   | false     | false      |
| order_headers       | order_headers_stripe_session_id_key     | CREATE UNIQUE INDEX order_headers_stripe_session_id_key ON public.order_headers USING btree (stripe_session_id)                                                                        | true      | false      |
| order_headers       | ux_order_headers_invoice                | CREATE UNIQUE INDEX ux_order_headers_invoice ON public.order_headers USING btree (stripe_invoice_id) WHERE (stripe_invoice_id IS NOT NULL)                                             | true      | false      |
| order_headers       | ux_order_headers_order_number           | CREATE UNIQUE INDEX ux_order_headers_order_number ON public.order_headers USING btree (order_number)                                                                                   | true      | false      |
| order_headers       | ux_order_headers_payment_intent         | CREATE UNIQUE INDEX ux_order_headers_payment_intent ON public.order_headers USING btree (stripe_payment_intent_id) WHERE (stripe_payment_intent_id IS NOT NULL)                        | true      | false      |
| order_headers       | ux_order_headers_stripe_subscription_id | CREATE UNIQUE INDEX ux_order_headers_stripe_subscription_id ON public.order_headers USING btree (stripe_subscription_id) WHERE (stripe_subscription_id IS NOT NULL)                    | true      | false      |
| order_items         | idx_order_items_order_id                | CREATE INDEX idx_order_items_order_id ON public.order_items USING btree (order_id)                                                                                                     | false     | false      |
| order_items         | idx_order_items_sku                     | CREATE INDEX idx_order_items_sku ON public.order_items USING btree (sku)                                                                                                               | false     | false      |
| order_items         | ux_order_items_order_line               | CREATE UNIQUE INDEX ux_order_items_order_line ON public.order_items USING btree (order_id, line_number)                                                                                | true      | false      |
| payments            | idx_payments_created_at                 | CREATE INDEX idx_payments_created_at ON public.payments USING btree (created_at DESC)                                                                                                  | false     | false      |
| payments            | idx_payments_order_id                   | CREATE INDEX idx_payments_order_id ON public.payments USING btree (order_id)                                                                                                           | false     | false      |
| payments            | idx_payments_spi                        | CREATE INDEX idx_payments_spi ON public.payments USING btree (stripe_payment_intent_id)                                                                                                | false     | false      |
| payments            | idx_payments_subscription_id            | CREATE INDEX idx_payments_subscription_id ON public.payments USING btree (stripe_subscription_id)                                                                                      | false     | false      |
| payments            | idx_payments_user_id                    | CREATE INDEX idx_payments_user_id ON public.payments USING btree (user_id)                                                                                                             | false     | false      |
| payments            | ux_payments_invoice_id                  | CREATE UNIQUE INDEX ux_payments_invoice_id ON public.payments USING btree (stripe_invoice_id) WHERE (stripe_invoice_id IS NOT NULL)                                                    | true      | false      |
| payments            | ux_payments_payment_intent_id           | CREATE UNIQUE INDEX ux_payments_payment_intent_id ON public.payments USING btree (stripe_payment_intent_id) WHERE (stripe_payment_intent_id IS NOT NULL)                               | true      | false      |
| product_prices      | idx_pp_rank_helper                      | CREATE INDEX idx_pp_rank_helper ON public.product_prices USING btree (sku, currency, "interval", price_list, created_at DESC) WHERE (active = true)                                    | false     | false      |
| product_prices      | idx_product_prices_active               | CREATE INDEX idx_product_prices_active ON public.product_prices USING btree (active) WHERE (active = true)                                                                             | false     | false      |
| product_prices      | idx_product_prices_currency             | CREATE INDEX idx_product_prices_currency ON public.product_prices USING btree (currency)                                                                                               | false     | false      |
| product_prices      | idx_product_prices_list                 | CREATE INDEX idx_product_prices_list ON public.product_prices USING btree (price_list)                                                                                                 | false     | false      |
| product_prices      | idx_product_prices_sku                  | CREATE INDEX idx_product_prices_sku ON public.product_prices USING btree (sku)                                                                                                         | false     | false      |
| product_prices      | idx_product_prices_sku_active           | CREATE INDEX idx_product_prices_sku_active ON public.product_prices USING btree (sku) WHERE (active = true)                                                                            | false     | false      |
| product_prices      | ux_product_prices_sku_cur_list_interval | CREATE UNIQUE INDEX ux_product_prices_sku_cur_list_interval ON public.product_prices USING btree (sku, currency, price_list, "interval")                                               | true      | false      |
| product_prices      | ux_product_prices_stripe                | CREATE UNIQUE INDEX ux_product_prices_stripe ON public.product_prices USING btree (stripe_price_id) WHERE (stripe_price_id IS NOT NULL)                                                | true      | false      |
| products            | idx_products_status                     | CREATE INDEX idx_products_status ON public.products USING btree (status)                                                                                                               | false     | false      |
| products            | idx_products_visibility                 | CREATE INDEX idx_products_visibility ON public.products USING btree (visibility)                                                                                                       | false     | false      |
| rate_limits         | rate_limits_updated_at_idx              | CREATE INDEX rate_limits_updated_at_idx ON public.rate_limits USING btree (updated_at)                                                                                                 | false     | false      |
| subscription_events | idx_subscription_events__contact_id     | CREATE INDEX idx_subscription_events__contact_id ON public.subscription_events USING btree (contact_id)                                                                                | false     | false      |
| subscription_events | idx_subscription_events__event_type     | CREATE INDEX idx_subscription_events__event_type ON public.subscription_events USING btree (event_type)                                                                                | false     | false      |
| subscription_events | idx_subscription_events__occurred_at    | CREATE INDEX idx_subscription_events__occurred_at ON public.subscription_events USING btree (occurred_at)                                                                              | false     | false      |
| subscription_events | subscription_events_idempotency_key_key | CREATE UNIQUE INDEX subscription_events_idempotency_key_key ON public.subscription_events USING btree (idempotency_key)                                                                | true      | false      |
| subscription_events | ux_subscription_events_idem             | CREATE UNIQUE INDEX ux_subscription_events_idem ON public.subscription_events USING btree (idempotency_key) WHERE (idempotency_key IS NOT NULL)                                        | true      | false      |
| thankyou_copy       | ix_thankyou_copy_locale                 | CREATE INDEX ix_thankyou_copy_locale ON public.thankyou_copy USING btree (locale)                                                                                                      | false     | false      |
| thankyou_copy       | ix_thankyou_copy_sku                    | CREATE INDEX ix_thankyou_copy_sku ON public.thankyou_copy USING btree (sku)                                                                                                            | false     | false      |
| thankyou_copy       | ux_thankyou_copy_sku_locale_country     | CREATE UNIQUE INDEX ux_thankyou_copy_sku_locale_country ON public.thankyou_copy USING btree (sku, locale, COALESCE(country, '*'::text))                                                | true      | false      |
| webhook_events      | idx_webhook_events_order_id             | CREATE INDEX idx_webhook_events_order_id ON public.webhook_events USING btree (order_id)                                                                                               | false     | false      |
| webhook_events      | idx_webhook_events_received_at          | CREATE INDEX idx_webhook_events_received_at ON public.webhook_events USING btree (received_at)                                                                                         | false     | false      |
| webhook_events      | webhook_events_stripe_event_id_key      | CREATE UNIQUE INDEX webhook_events_stripe_event_id_key ON public.webhook_events USING btree (stripe_event_id)                                                                          | true      | false      |


-- Paso 4.5 — RLS por tabla (on/off) y detalle de policies

-- 4.5.a Resumen RLS por tabla
WITH tbl AS (
  SELECT c.oid, c.relname AS table_name, c.relrowsecurity AS rls_enabled
  FROM pg_class c
  JOIN pg_namespace n ON n.oid = c.relnamespace
  WHERE n.nspname = 'public' AND c.relkind = 'r'
),
pol AS (
  SELECT polrelid, count(*) AS policy_count
  FROM pg_policy
  GROUP BY polrelid
)
SELECT t.table_name, t.rls_enabled, COALESCE(p.policy_count,0) AS policy_count
FROM tbl t
LEFT JOIN pol p ON p.polrelid = t.oid
ORDER BY t.table_name;

| table_name          | rls_enabled | policy_count |
| ------------------- | ----------- | ------------ |
| bundle_items        | true        | 2            |
| bundles             | true        | 2            |
| contacts            | true        | 1            |
| entitlement_events  | true        | 1            |
| entitlements        | true        | 2            |
| exclusivity_members | true        | 2            |
| exclusivity_sets    | true        | 2            |
| incompatibilities   | true        | 2            |
| messages            | true        | 1            |
| order_documents     | true        | 2            |
| order_events        | true        | 2            |
| order_headers       | true        | 2            |
| order_items         | true        | 2            |
| payments            | true        | 2            |
| product_prices      | true        | 2            |
| products            | true        | 2            |
| rate_limits         | true        | 0            |
| subscription_events | true        | 2            |
| thankyou_copy       | true        | 1            |
| webhook_events      | true        | 2            |

-- 4.5.b Detalle de cada policy
SELECT
  n.nspname                         AS schema,
  c.relname                         AS table_name,
  p.polname                         AS policy_name,
  p.polcmd                          AS command,              -- r = SELECT, a = INSERT, w = UPDATE, d = DELETE
  array_to_string(p.polroles::regrole[], ',') AS roles,
  COALESCE(pg_get_expr(p.polqual, p.polrelid), '—')       AS using_expr,
  COALESCE(pg_get_expr(p.polwithcheck, p.polrelid), '—')  AS with_check_expr
FROM pg_policy p
JOIN pg_class c     ON c.oid = p.polrelid
JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE n.nspname = 'public'
ORDER BY table_name, policy_name;

| schema | table_name          | policy_name                          | command | roles              | using_expr                                                                                                                                                                                                       | with_check_expr |
| ------ | ------------------- | ------------------------------------ | ------- | ------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------- |
| public | bundle_items        | bundle_items_all_service_role        | *       | service_role       | true                                                                                                                                                                                                             | true            |
| public | bundle_items        | bundle_items_select_public           | r       | anon,authenticated | (EXISTS ( SELECT 1
   FROM (bundles b
     JOIN products p ON ((p.sku = b.bundle_sku)))
  WHERE ((b.bundle_sku = bundle_items.bundle_sku) AND (p.visibility = 'public'::text) AND (p.status = 'active'::text)))) | —               |
| public | bundles             | bundles_all_service_role             | *       | service_role       | true                                                                                                                                                                                                             | true            |
| public | bundles             | bundles_select_public                | r       | anon,authenticated | (EXISTS ( SELECT 1
   FROM products p
  WHERE ((p.sku = bundles.bundle_sku) AND (p.visibility = 'public'::text) AND (p.status = 'active'::text))))                                                               | —               |
| public | contacts            | contacts_all_service_role            | *       | service_role       | true                                                                                                                                                                                                             | true            |
| public | entitlement_events  | entitlement_events_select_owner      | r       | authenticated      | (EXISTS ( SELECT 1
   FROM entitlements e
  WHERE ((e.id = entitlement_events.entitlement_id) AND (e.user_id = current_user_id()))))                                                                             | —               |
| public | entitlements        | entitlements_select_owner            | r       | authenticated      | (user_id = current_user_id())                                                                                                                                                                                    | —               |
| public | entitlements        | entitlements_write_service_role      | *       | service_role       | true                                                                                                                                                                                                             | true            |
| public | exclusivity_members | exclusivity_members_all_service_role | *       | service_role       | true                                                                                                                                                                                                             | true            |
| public | exclusivity_members | exclusivity_members_none_auth        | r       | authenticated      | false                                                                                                                                                                                                            | —               |
| public | exclusivity_sets    | exclusivity_sets_all_service_role    | *       | service_role       | true                                                                                                                                                                                                             | true            |
| public | exclusivity_sets    | exclusivity_sets_none_auth           | r       | authenticated      | false                                                                                                                                                                                                            | —               |
| public | incompatibilities   | incompatibilities_all_service_role   | *       | service_role       | true                                                                                                                                                                                                             | true            |
| public | incompatibilities   | incompatibilities_none_auth          | r       | authenticated      | false                                                                                                                                                                                                            | —               |
| public | messages            | messages_all_service_role            | *       | service_role       | true                                                                                                                                                                                                             | true            |
| public | order_documents     | order_documents_select_owner         | r       | authenticated      | (EXISTS ( SELECT 1
   FROM order_headers h
  WHERE ((h.id = order_documents.order_id) AND (h.user_id = current_user_id()))))                                                                                     | —               |
| public | order_documents     | order_documents_write_service_role   | *       | service_role       | true                                                                                                                                                                                                             | true            |
| public | order_events        | order_events_select_owner            | r       | authenticated      | (EXISTS ( SELECT 1
   FROM order_headers h
  WHERE ((h.id = order_events.order_id) AND (h.user_id = current_user_id()))))                                                                                        | —               |
| public | order_events        | order_events_write_service_role      | *       | service_role       | true                                                                                                                                                                                                             | true            |
| public | order_headers       | order_headers_select_owner           | r       | authenticated      | (user_id = current_user_id())                                                                                                                                                                                    | —               |
| public | order_headers       | order_headers_write_service_role     | *       | service_role       | true                                                                                                                                                                                                             | true            |
| public | order_items         | order_items_select_owner             | r       | authenticated      | (EXISTS ( SELECT 1
   FROM order_headers h
  WHERE ((h.id = order_items.order_id) AND (h.user_id = current_user_id()))))                                                                                         | —               |
| public | order_items         | order_items_write_service_role       | *       | service_role       | true                                                                                                                                                                                                             | true            |
| public | payments            | payments_select_owner                | r       | authenticated      | (user_id = current_user_id())                                                                                                                                                                                    | —               |
| public | payments            | payments_write_service_role          | *       | service_role       | true                                                                                                                                                                                                             | true            |
| public | product_prices      | product_prices_all_service_role      | *       | service_role       | true                                                                                                                                                                                                             | true            |
| public | product_prices      | product_prices_select_public_active  | r       | authenticated,anon | (active = true)                                                                                                                                                                                                  | —               |
| public | products            | products_all_service_role            | *       | service_role       | true                                                                                                                                                                                                             | true            |
| public | products            | products_select_public               | r       | authenticated,anon | true                                                                                                                                                                                                             | —               |
| public | subscription_events | subscription_events_insert_sr        | a       | service_role       | —                                                                                                                                                                                                                | true            |
| public | subscription_events | subscription_events_select_sr        | r       | service_role       | true                                                                                                                                                                                                             | —               |
| public | thankyou_copy       | thankyou_copy_select_public          | r       | -                  | true                                                                                                                                                                                                             | —               |
| public | webhook_events      | webhook_events_all_service_role      | *       | service_role       | true                                                                                                                                                                                                             | true            |
| public | webhook_events      | webhook_events_select_none           | r       | authenticated,anon | false                                                                                                                                                                                                            | —               |


SELECT
  p.proname                              AS function_name,
  pg_get_function_identity_arguments(p.oid) AS args,
  pg_get_function_result(p.oid)          AS returns,
  l.lanname                              AS language,
  p.prosecdef                            AS security_definer,  -- true/false
  p.provolatile                          AS volatility         -- i=IMMUTABLE, s=STABLE, v=VOLATILE
FROM pg_proc p
JOIN pg_namespace n ON n.oid = p.pronamespace
JOIN pg_language l ON l.oid = p.prolang
WHERE n.nspname = 'public'
ORDER BY function_name;

| function_name                             | args                                                                                                                                                                                                                                   | returns                                                                                                                                                                                                                                                                                                                                                                         | language | security_definer | volatility |
| ----------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- | ---------------- | ---------- |
| citext                                    | boolean                                                                                                                                                                                                                                | citext                                                                                                                                                                                                                                                                                                                                                                          | internal | false            | i          |
| citext                                    | inet                                                                                                                                                                                                                                   | citext                                                                                                                                                                                                                                                                                                                                                                          | internal | false            | i          |
| citext                                    | character                                                                                                                                                                                                                              | citext                                                                                                                                                                                                                                                                                                                                                                          | internal | false            | i          |
| citext_cmp                                | citext, citext                                                                                                                                                                                                                         | integer                                                                                                                                                                                                                                                                                                                                                                         | c        | false            | i          |
| citext_eq                                 | citext, citext                                                                                                                                                                                                                         | boolean                                                                                                                                                                                                                                                                                                                                                                         | c        | false            | i          |
| citext_ge                                 | citext, citext                                                                                                                                                                                                                         | boolean                                                                                                                                                                                                                                                                                                                                                                         | c        | false            | i          |
| citext_gt                                 | citext, citext                                                                                                                                                                                                                         | boolean                                                                                                                                                                                                                                                                                                                                                                         | c        | false            | i          |
| citext_hash                               | citext                                                                                                                                                                                                                                 | integer                                                                                                                                                                                                                                                                                                                                                                         | c        | false            | i          |
| citext_hash_extended                      | citext, bigint                                                                                                                                                                                                                         | bigint                                                                                                                                                                                                                                                                                                                                                                          | c        | false            | i          |
| citext_larger                             | citext, citext                                                                                                                                                                                                                         | citext                                                                                                                                                                                                                                                                                                                                                                          | c        | false            | i          |
| citext_le                                 | citext, citext                                                                                                                                                                                                                         | boolean                                                                                                                                                                                                                                                                                                                                                                         | c        | false            | i          |
| citext_lt                                 | citext, citext                                                                                                                                                                                                                         | boolean                                                                                                                                                                                                                                                                                                                                                                         | c        | false            | i          |
| citext_ne                                 | citext, citext                                                                                                                                                                                                                         | boolean                                                                                                                                                                                                                                                                                                                                                                         | c        | false            | i          |
| citext_pattern_cmp                        | citext, citext                                                                                                                                                                                                                         | integer                                                                                                                                                                                                                                                                                                                                                                         | c        | false            | i          |
| citext_pattern_ge                         | citext, citext                                                                                                                                                                                                                         | boolean                                                                                                                                                                                                                                                                                                                                                                         | c        | false            | i          |
| citext_pattern_gt                         | citext, citext                                                                                                                                                                                                                         | boolean                                                                                                                                                                                                                                                                                                                                                                         | c        | false            | i          |
| citext_pattern_le                         | citext, citext                                                                                                                                                                                                                         | boolean                                                                                                                                                                                                                                                                                                                                                                         | c        | false            | i          |
| citext_pattern_lt                         | citext, citext                                                                                                                                                                                                                         | boolean                                                                                                                                                                                                                                                                                                                                                                         | c        | false            | i          |
| citext_smaller                            | citext, citext                                                                                                                                                                                                                         | citext                                                                                                                                                                                                                                                                                                                                                                          | c        | false            | i          |
| citextin                                  | cstring                                                                                                                                                                                                                                | citext                                                                                                                                                                                                                                                                                                                                                                          | internal | false            | i          |
| citextout                                 | citext                                                                                                                                                                                                                                 | cstring                                                                                                                                                                                                                                                                                                                                                                         | internal | false            | i          |
| citextrecv                                | internal                                                                                                                                                                                                                               | citext                                                                                                                                                                                                                                                                                                                                                                          | internal | false            | s          |
| citextsend                                | citext                                                                                                                                                                                                                                 | bytea                                                                                                                                                                                                                                                                                                                                                                           | internal | false            | s          |
| current_user_id                           |                                                                                                                                                                                                                                        | uuid                                                                                                                                                                                                                                                                                                                                                                            | sql      | false            | s          |
| f_audit_set_updated_at                    |                                                                                                                                                                                                                                        | trigger                                                                                                                                                                                                                                                                                                                                                                         | plpgsql  | false            | v          |
| f_audit_updated_at_only_update            |                                                                                                                                                                                                                                        | trigger                                                                                                                                                                                                                                                                                                                                                                         | plpgsql  | false            | v          |
| f_auth_get_user                           | p_email text                                                                                                                                                                                                                           | uuid                                                                                                                                                                                                                                                                                                                                                                            | plpgsql  | true             | v          |
| f_block_update_delete                     |                                                                                                                                                                                                                                        | trigger                                                                                                                                                                                                                                                                                                                                                                         | plpgsql  | false            | v          |
| f_bundles_expand_items                    | p_bundle_sku text                                                                                                                                                                                                                      | TABLE(sku text, fulfillment_type text)                                                                                                                                                                                                                                                                                                                                          | plpgsql  | true             | v          |
| f_catalog_price_by_sku                    | p_sku text, p_currency text                                                                                                                                                                                                            | TABLE(stripe_price_id text, amount_cents integer, currency text, metadata jsonb)                                                                                                                                                                                                                                                                                                | plpgsql  | true             | s          |
| f_debug_get_entitlements_by_order         | p_order_id uuid                                                                                                                                                                                                                        | TABLE(id uuid, user_id uuid, sku text, fulfillment_type text, source_type entitlement_source_type, source_id text, active boolean, valid_until timestamp with time zone, metadata jsonb, created_at timestamp with time zone, updated_at timestamp with time zone)                                                                                                              | plpgsql  | true             | v          |
| f_debug_get_order                         | p_order_id uuid                                                                                                                                                                                                                        | TABLE(id uuid, user_id uuid, order_number text, total_cents integer, currency text, status text, stripe_session_id text, stripe_invoice_id text, stripe_subscription_id text, stripe_payment_intent_id text, stripe_customer_id text, metadata jsonb, created_at timestamp with time zone, updated_at timestamp with time zone)                                                 | plpgsql  | true             | v          |
| f_debug_get_payments_by_order             | p_order_id uuid                                                                                                                                                                                                                        | TABLE(id uuid, user_id uuid, order_id uuid, total_cents integer, currency text, status text, stripe_invoice_id text, stripe_payment_intent_id text, stripe_subscription_id text, stripe_customer_id text, period_start timestamp with time zone, period_end timestamp with time zone, metadata jsonb, created_at timestamp with time zone, updated_at timestamp with time zone) | plpgsql  | true             | v          |
| f_debug_orders_parse_payment_from_payload | session_payload jsonb                                                                                                                                                                                                                  | TABLE(amount_cents integer, currency text, seen_total integer, seen_amount_paid integer, seen_amount_due integer, seen_subtotal integer, seen_currency text, line0_amount integer, line0_price_currency text)                                                                                                                                                                   | plpgsql  | true             | v          |
| f_debug_orders_payment_both               | session_payload jsonb                                                                                                                                                                                                                  | TABLE(manual_amount_cents integer, manual_currency text, parser_amount_cents integer, parser_currency text, seen_total integer, seen_amount_paid integer, seen_amount_due integer, seen_subtotal integer, seen_currency text, line0_amount integer, line0_amount_total integer, line0_currency text, line0_price_currency text)                                                 | plpgsql  | true             | v          |
| f_entitlements_apply                      | p_user_id uuid, p_order_id uuid, p_sku text, p_fulfillment_type text, p_metadata jsonb, p_valid_until timestamp with time zone, p_actor text                                                                                           | uuid                                                                                                                                                                                                                                                                                                                                                                            | plpgsql  | true             | v          |
| f_entitlements_grant                      | p_user_id uuid, p_sku text, p_fulfillment_type text, p_source_type text, p_source_id text, p_metadata jsonb, p_valid_until timestamp with time zone, p_actor text                                                                      | uuid                                                                                                                                                                                                                                                                                                                                                                            | plpgsql  | true             | v          |
| f_entitlements_renew_subscription         | p_entitlement_id uuid, p_metadata jsonb, p_valid_until timestamp with time zone, p_actor text, p_was_existing boolean                                                                                                                  | timestamp with time zone                                                                                                                                                                                                                                                                                                                                                        | plpgsql  | true             | v          |
| f_orch_contact_write                      | p_input jsonb                                                                                                                                                                                                                          | jsonb                                                                                                                                                                                                                                                                                                                                                                           | sql      | true             | v          |
| f_orch_contact_write_v1                   | p_input jsonb                                                                                                                                                                                                                          | jsonb                                                                                                                                                                                                                                                                                                                                                                           | plpgsql  | true             | v          |
| f_orch_orders_upsert                      | session_payload jsonb                                                                                                                                                                                                                  | uuid                                                                                                                                                                                                                                                                                                                                                                            | plpgsql  | true             | v          |
| f_order_headers_upsert                    | p_user_id uuid, p_total_cents integer, p_currency text, p_status text, p_stripe_session_id text, p_stripe_invoice_id text, p_stripe_subscription_id text, p_stripe_payment_intent_id text, p_stripe_customer_id text, p_metadata jsonb | uuid                                                                                                                                                                                                                                                                                                                                                                            | plpgsql  | true             | v          |
| f_orders_new_order_number                 |                                                                                                                                                                                                                                        | text                                                                                                                                                                                                                                                                                                                                                                            | plpgsql  | true             | v          |
| f_orders_parse_keys                       | p_obj jsonb, p_event_type text                                                                                                                                                                                                         | TABLE(session_id text, invoice_id text, subscription_id text)                                                                                                                                                                                                                                                                                                                   | plpgsql  | true             | v          |
| f_orders_parse_metadata                   | p_obj jsonb                                                                                                                                                                                                                            | TABLE(sku text, fulfillment_type text)                                                                                                                                                                                                                                                                                                                                          | plpgsql  | true             | v          |
| f_orders_parse_payment                    | p_obj jsonb                                                                                                                                                                                                                            | TABLE(amount_cents integer, currency text)                                                                                                                                                                                                                                                                                                                                      | plpgsql  | true             | v          |
| f_orders_resolve_user                     | p_obj jsonb                                                                                                                                                                                                                            | uuid                                                                                                                                                                                                                                                                                                                                                                            | plpgsql  | true             | v          |
| f_payments_upsert                         | p_user_id uuid, p_obj jsonb, p_order_id uuid                                                                                                                                                                                           | uuid                                                                                                                                                                                                                                                                                                                                                                            | plpgsql  | true             | v          |
| f_payments_upsert_by_session              | p_payment_intent jsonb, p_session jsonb, p_order_id uuid                                                                                                                                                                               | TABLE(payment_id uuid, order_id uuid)                                                                                                                                                                                                                                                                                                                                           | plpgsql  | true             | v          |
| f_rate_limit_touch_v1                     | v_input jsonb                                                                                                                                                                                                                          | jsonb                                                                                                                                                                                                                                                                                                                                                                           | plpgsql  | true             | v          |
| f_webhookevents_getbystripeid             | p_stripe_event_id text                                                                                                                                                                                                                 | webhook_events                                                                                                                                                                                                                                                                                                                                                                  | plpgsql  | false            | s          |
| f_webhooks_log_event                      | p_stripe_event_id text, p_type text, p_payload jsonb                                                                                                                                                                                   | void                                                                                                                                                                                                                                                                                                                                                                            | plpgsql  | true             | v          |
| f_webhooks_mark_processed                 | p_stripe_event_id text, p_order_id uuid                                                                                                                                                                                                | void                                                                                                                                                                                                                                                                                                                                                                            | plpgsql  | true             | v          |
| max                                       | citext                                                                                                                                                                                                                                 | citext                                                                                                                                                                                                                                                                                                                                                                          | internal | false            | i          |
| min                                       | citext                                                                                                                                                                                                                                 | citext                                                                                                                                                                                                                                                                                                                                                                          | internal | false            | i          |
| regexp_match                              | citext, citext, text                                                                                                                                                                                                                   | text[]                                                                                                                                                                                                                                                                                                                                                                          | sql      | false            | i          |
| regexp_match                              | citext, citext                                                                                                                                                                                                                         | text[]                                                                                                                                                                                                                                                                                                                                                                          | sql      | false            | i          |
| regexp_matches                            | citext, citext                                                                                                                                                                                                                         | SETOF text[]                                                                                                                                                                                                                                                                                                                                                                    | sql      | false            | i          |
| regexp_matches                            | citext, citext, text                                                                                                                                                                                                                   | SETOF text[]                                                                                                                                                                                                                                                                                                                                                                    | sql      | false            | i          |
| regexp_replace                            | citext, citext, text                                                                                                                                                                                                                   | text                                                                                                                                                                                                                                                                                                                                                                            | sql      | false            | i          |
| regexp_replace                            | citext, citext, text, text                                                                                                                                                                                                             | text                                                                                                                                                                                                                                                                                                                                                                            | sql      | false            | i          |
| regexp_split_to_array                     | citext, citext, text                                                                                                                                                                                                                   | text[]                                                                                                                                                                                                                                                                                                                                                                          | sql      | false            | i          |
| regexp_split_to_array                     | citext, citext                                                                                                                                                                                                                         | text[]                                                                                                                                                                                                                                                                                                                                                                          | sql      | false            | i          |
| regexp_split_to_table                     | citext, citext                                                                                                                                                                                                                         | SETOF text                                                                                                                                                                                                                                                                                                                                                                      | sql      | false            | i          |
| regexp_split_to_table                     | citext, citext, text                                                                                                                                                                                                                   | SETOF text                                                                                                                                                                                                                                                                                                                                                                      | sql      | false            | i          |
| replace                                   | citext, citext, citext                                                                                                                                                                                                                 | text                                                                                                                                                                                                                                                                                                                                                                            | sql      | false            | i          |
| split_part                                | citext, citext, integer                                                                                                                                                                                                                | text                                                                                                                                                                                                                                                                                                                                                                            | sql      | false            | i          |
| strpos                                    | citext, citext                                                                                                                                                                                                                         | integer                                                                                                                                                                                                                                                                                                                                                                         | sql      | false            | i          |
| texticlike                                | citext, citext                                                                                                                                                                                                                         | boolean                                                                                                                                                                                                                                                                                                                                                                         | internal | false            | i          |
| texticlike                                | citext, text                                                                                                                                                                                                                           | boolean                                                                                                                                                                                                                                                                                                                                                                         | internal | false            | i          |
| texticnlike                               | citext, text                                                                                                                                                                                                                           | boolean                                                                                                                                                                                                                                                                                                                                                                         | internal | false            | i          |
| texticnlike                               | citext, citext                                                                                                                                                                                                                         | boolean                                                                                                                                                                                                                                                                                                                                                                         | internal | false            | i          |
| texticregexeq                             | citext, text                                                                                                                                                                                                                           | boolean                                                                                                                                                                                                                                                                                                                                                                         | internal | false            | i          |
| texticregexeq                             | citext, citext                                                                                                                                                                                                                         | boolean                                                                                                                                                                                                                                                                                                                                                                         | internal | false            | i          |
| texticregexne                             | citext, citext                                                                                                                                                                                                                         | boolean                                                                                                                                                                                                                                                                                                                                                                         | internal | false            | i          |
| texticregexne                             | citext, text                                                                                                                                                                                                                           | boolean                                                                                                                                                                                                                                                                                                                                                                         | internal | false            | i          |
| tg_set_updated_at                         |                                                                                                                                                                                                                                        | trigger                                                                                                                                                                                                                                                                                                                                                                         | plpgsql  | false            | v          |
| translate                                 | citext, citext, text                                                                                                                                                                                                                   | text                                                                                                                                                                                                                                                                                                                                                                            | sql      | false            | i          |


-- 4.7 — Triggers activos en el esquema público
SELECT
  c.relname                     AS table_name,
  t.tgname                      AS trigger_name,
  p.proname                     AS function_name,
  t.tgenabled                   AS enabled,               -- O/D/R/A (O=ON, D=DISABLED)
  pg_get_triggerdef(t.oid)      AS trigger_ddl
FROM pg_trigger t
JOIN pg_class c     ON c.oid = t.tgrelid
JOIN pg_proc  p     ON p.oid = t.tgfoid
JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE n.nspname = 'public'
  AND NOT t.tgisinternal
ORDER BY c.relname, t.tgname;


| table_name          | trigger_name                              | function_name                     | enabled | trigger_ddl                                                                                                                                                          |
| ------------------- | ----------------------------------------- | --------------------------------- | ------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| bundle_items        | trg_bundle_items_updated_at               | f_audit_set_updated_at            | O       | CREATE TRIGGER trg_bundle_items_updated_at BEFORE UPDATE ON public.bundle_items FOR EACH ROW EXECUTE FUNCTION f_audit_set_updated_at()                               |
| bundles             | trg_bundles_updated_at                    | f_audit_set_updated_at            | O       | CREATE TRIGGER trg_bundles_updated_at BEFORE UPDATE ON public.bundles FOR EACH ROW EXECUTE FUNCTION f_audit_set_updated_at()                                         |
| contacts            | trg_contacts__touch_updated_at            | f_audit_updated_at_only_update    | O       | CREATE TRIGGER trg_contacts__touch_updated_at BEFORE UPDATE ON public.contacts FOR EACH ROW EXECUTE FUNCTION f_audit_updated_at_only_update()                        |
| contacts            | trg_contacts__updated_at                  | f_audit_updated_at_only_update_v1 | O       | CREATE TRIGGER trg_contacts__updated_at BEFORE UPDATE ON public.contacts FOR EACH ROW EXECUTE FUNCTION app.f_audit_updated_at_only_update_v1()                       |
| entitlement_events  | trg_entitlement_events_updated_at         | f_audit_set_updated_at            | O       | CREATE TRIGGER trg_entitlement_events_updated_at BEFORE UPDATE ON public.entitlement_events FOR EACH ROW EXECUTE FUNCTION f_audit_set_updated_at()                   |
| entitlements        | trg_entitlements_updated_at               | f_audit_set_updated_at            | O       | CREATE TRIGGER trg_entitlements_updated_at BEFORE UPDATE ON public.entitlements FOR EACH ROW EXECUTE FUNCTION f_audit_set_updated_at()                               |
| exclusivity_members | trg_exclusivity_members_updated_at        | f_audit_set_updated_at            | O       | CREATE TRIGGER trg_exclusivity_members_updated_at BEFORE UPDATE ON public.exclusivity_members FOR EACH ROW EXECUTE FUNCTION f_audit_set_updated_at()                 |
| exclusivity_sets    | trg_exclusivity_sets_updated_at           | f_audit_set_updated_at            | O       | CREATE TRIGGER trg_exclusivity_sets_updated_at BEFORE UPDATE ON public.exclusivity_sets FOR EACH ROW EXECUTE FUNCTION f_audit_set_updated_at()                       |
| messages            | trg_messages__touch_updated_at            | f_audit_updated_at_only_update    | O       | CREATE TRIGGER trg_messages__touch_updated_at BEFORE UPDATE ON public.messages FOR EACH ROW EXECUTE FUNCTION f_audit_updated_at_only_update()                        |
| messages            | trg_messages__updated_at                  | f_audit_updated_at_only_update_v1 | O       | CREATE TRIGGER trg_messages__updated_at BEFORE UPDATE ON public.messages FOR EACH ROW EXECUTE FUNCTION app.f_audit_updated_at_only_update_v1()                       |
| order_documents     | trg_order_documents_updated_at            | f_audit_set_updated_at            | O       | CREATE TRIGGER trg_order_documents_updated_at BEFORE UPDATE ON public.order_documents FOR EACH ROW EXECUTE FUNCTION f_audit_set_updated_at()                         |
| order_events        | trg_order_events_updated_at               | f_audit_set_updated_at            | O       | CREATE TRIGGER trg_order_events_updated_at BEFORE UPDATE ON public.order_events FOR EACH ROW EXECUTE FUNCTION f_audit_set_updated_at()                               |
| order_headers       | trg_order_headers_updated_at              | f_audit_set_updated_at            | O       | CREATE TRIGGER trg_order_headers_updated_at BEFORE UPDATE ON public.order_headers FOR EACH ROW EXECUTE FUNCTION f_audit_set_updated_at()                             |
| order_items         | trg_order_items_updated_at                | f_audit_set_updated_at            | O       | CREATE TRIGGER trg_order_items_updated_at BEFORE UPDATE ON public.order_items FOR EACH ROW EXECUTE FUNCTION f_audit_set_updated_at()                                 |
| product_prices      | trg_product_prices_updated_at             | f_audit_set_updated_at            | O       | CREATE TRIGGER trg_product_prices_updated_at BEFORE UPDATE ON public.product_prices FOR EACH ROW EXECUTE FUNCTION f_audit_set_updated_at()                           |
| products            | trg_products_updated_at                   | f_audit_set_updated_at            | O       | CREATE TRIGGER trg_products_updated_at BEFORE UPDATE ON public.products FOR EACH ROW EXECUTE FUNCTION f_audit_set_updated_at()                                       |
| subscription_events | trg_subscription_events__block_ud         | f_block_update_delete             | O       | CREATE TRIGGER trg_subscription_events__block_ud BEFORE DELETE OR UPDATE ON public.subscription_events FOR EACH ROW EXECUTE FUNCTION f_block_update_delete()         |
| subscription_events | trg_subscription_events__touch_updated_at | f_audit_updated_at_only_update    | O       | CREATE TRIGGER trg_subscription_events__touch_updated_at BEFORE UPDATE ON public.subscription_events FOR EACH ROW EXECUTE FUNCTION f_audit_updated_at_only_update()  |
| subscription_events | trg_subscription_events__updated_at       | f_audit_updated_at_only_update_v1 | O       | CREATE TRIGGER trg_subscription_events__updated_at BEFORE UPDATE ON public.subscription_events FOR EACH ROW EXECUTE FUNCTION app.f_audit_updated_at_only_update_v1() |
| thankyou_copy       | trg_thankyou_copy_updated_at              | tg_set_updated_at                 | O       | CREATE TRIGGER trg_thankyou_copy_updated_at BEFORE UPDATE ON public.thankyou_copy FOR EACH ROW EXECUTE FUNCTION tg_set_updated_at()                                  |

-- 4.8 — Vistas en schema public
SELECT
  c.relname                     AS view_name,
  CASE c.relkind WHEN 'm' THEN 'materialized' ELSE 'view' END AS kind,
  pg_get_viewdef(c.oid, true)   AS view_sql
FROM pg_class c
JOIN pg_namespace n ON n.oid = c.relnamespace
WHERE n.nspname = 'public'
  AND c.relkind IN ('v','m')
ORDER BY c.relname;


| view_name              | kind | view_sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ---------------------- | ---- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| v_entitlements_active  | view |  SELECT id,
    user_id,
    sku,
    fulfillment_type,
    source_type,
    source_id,
    active,
    valid_until,
    revoked_at,
    metadata,
    created_at,
    updated_at
   FROM entitlements e
  WHERE active IS TRUE AND revoked_at IS NULL AND (valid_until IS NULL OR valid_until > now());                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| v_orders_with_payments | view |  WITH agg AS (
         SELECT payments.order_id,
            count(*)::integer AS payments_count,
            COALESCE(sum(
                CASE
                    WHEN payments.status = 'paid'::text THEN payments.total_cents
                    ELSE 0
                END), 0::bigint)::integer AS total_paid_cents
           FROM payments
          GROUP BY payments.order_id
        ), last_paid AS (
         SELECT DISTINCT ON (payments.order_id) payments.order_id,
            payments.id AS last_payment_id,
            payments.created_at AS last_paid_at
           FROM payments
          WHERE payments.status = 'paid'::text
          ORDER BY payments.order_id, payments.created_at DESC
        )
 SELECT oh.id AS order_id,
    oh.user_id,
    oh.order_number,
    oh.total_cents AS order_total_cents,
    lower(oh.currency) AS currency,
    oh.status AS order_status,
    oh.fulfillment_status,
    oh.invoice_status,
    oh.created_at AS order_created_at,
    oh.stripe_session_id,
    oh.stripe_payment_intent_id,
    oh.stripe_invoice_id,
    oh.stripe_subscription_id,
    oh.stripe_customer_id,
    COALESCE(agg.payments_count, 0) AS payments_count,
    COALESCE(agg.total_paid_cents, 0) AS total_paid_cents,
    COALESCE(agg.total_paid_cents, 0) >= oh.total_cents AS is_paid,
    oh.total_cents - COALESCE(agg.total_paid_cents, 0) AS balance_cents,
    last_paid.last_paid_at,
    last_paid.last_payment_id
   FROM order_headers oh
     LEFT JOIN agg ON agg.order_id = oh.id
     LEFT JOIN last_paid ON last_paid.order_id = oh.id;                                                                                                                                                                                                                                     |
| v_prices_vigente       | view |  SELECT id,
    sku,
    amount_cents,
    currency,
    price_list,
    "interval",
    valid_from,
    valid_until,
    active,
    stripe_price_id,
    metadata,
    created_at,
    updated_at
   FROM product_prices pp
  WHERE active = true AND (valid_from IS NULL OR valid_from <= now()) AND (valid_until IS NULL OR now() < valid_until);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| v_products_public      | view |  WITH ranked AS (
         SELECT vpa.id,
            vpa.sku,
            vpa.currency,
            vpa.price_list,
            vpa."interval",
            vpa.amount_cents,
            vpa.valid_from,
            vpa.valid_until,
            vpa.active,
            vpa.stripe_price_id,
            vpa.metadata,
            vpa.created_at,
            vpa.updated_at,
            row_number() OVER (PARTITION BY vpa.sku, vpa.currency, vpa."interval" ORDER BY (
                CASE vpa.price_list
                    WHEN 'launch'::text THEN 1
                    WHEN 'default'::text THEN 2
                    ELSE 99
                END), vpa.created_at DESC) AS rn
           FROM v_prices_vigente vpa
        ), best_mxn AS (
         SELECT r.sku,
            r.amount_cents AS price_mxn_cents,
            r."interval" AS price_mxn_interval,
            r.stripe_price_id AS price_mxn_stripe_price_id
           FROM ranked r
          WHERE r.currency = 'MXN'::text AND r.rn = 1
        ), best_usd AS (
         SELECT r.sku,
            r.amount_cents AS price_usd_cents,
            r."interval" AS price_usd_interval,
            r.stripe_price_id AS price_usd_stripe_price_id
           FROM ranked r
          WHERE r.currency = 'USD'::text AND r.rn = 1
        )
 SELECT p.sku,
    p.product_type,
    p.name,
    p.description,
    p.status,
    p.visibility,
    p.metadata,
    p.created_at,
    p.updated_at,
    mx.price_mxn_cents,
    mx.price_mxn_interval,
    mx.price_mxn_stripe_price_id,
    us.price_usd_cents,
    us.price_usd_interval,
    us.price_usd_stripe_price_id
   FROM products p
     LEFT JOIN best_mxn mx ON mx.sku = p.sku
     LEFT JOIN best_usd us ON us.sku = p.sku
  WHERE p.status = 'active'::text AND p.visibility = 'public'::text; |